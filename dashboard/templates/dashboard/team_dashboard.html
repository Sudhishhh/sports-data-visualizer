<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Data Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; }
        .dashboard-header { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: none; margin-bottom: 2rem; height: 100%; }
        .card-header { background-color: #ffffff; border-bottom: 2px solid #e9ecef; font-weight: bold; }
        .search-container { background: white; border-radius: 10px; padding: 2rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .error { display: none; margin-top: 1rem; }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body>
    <div class="dashboard-header"><div class="container text-center"><h1>Sports Data Visualizer</h1><p class="lead">Analyze Team Performance and League Standings</p></div></div>
    <div class="container">
        <div class="row justify-content-center"><div class="col-md-12"><div class="search-container"><div class="row g-2 align-items-end">
            <div class="col-md-3"><label class="form-label">Season</label><input type="text" id="seasonInput" class="form-control" placeholder="e.g. 2024-2025" value="2024-2025"></div>
            <div class="col-md-3"><label class="form-label">Team 1</label><select id="teamSelect1" class="form-select"><option value="" selected disabled>Select Team 1</option></select></div>
            <div class="col-md-3"><label class="form-label">Team 2 (H2H)</label><select id="teamSelect2" class="form-select"><option value="" selected disabled>Select Team 2</option></select></div>
            <div class="col-md-3 d-grid gap-2"><button id="searchBtn" class="btn btn-primary">Analyze</button><button id="tableBtn" class="btn btn-secondary">League Table</button></div>
        </div></div></div></div>
        <div class="alert alert-danger error" id="error-message"></div>
        <div class="row mt-4" id="teamChartsSection" style="display: none;">
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5 id="team1NameHeader" class="mb-0"></h5></div><div class="card-body chart-container"><canvas id="resultsChart"></canvas></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Team Form (Rolling 5)</h5></div><div class="card-body chart-container"><canvas id="formChart"></canvas></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Goals Over Time</h5></div><div class="card-body chart-container"><canvas id="goalsChart"></canvas></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Cumulative Points</h5></div><div class="card-body chart-container"><canvas id="cumulativeChart"></canvas></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Goal Difference Per Match</h5></div><div class="card-body chart-container"><canvas id="goalDiffChart"></canvas></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Home vs Away Breakdown</h5></div><div class="card-body chart-container"><canvas id="homeAwayChart"></canvas></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Goals Histogram</h5></div><div class="card-body chart-container"><canvas id="goalsHistChart"></canvas></div></div></div>
            <div class="col-md-8 mb-4"><div class="card"><div class="card-header"><h5>Matplotlib Form PNG</h5></div><div class="card-body text-center"><img id="mplImage" alt="Form plot" style="max-width:100%;height:auto"/></div></div></div>
        </div>

        <div class="row" id="pandasMplSection" style="display:none;">
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Univariate: Goals Histogram</h5></div><div class="card-body text-center"><img id="imgHistGoals" alt="Goals Histogram" style="max-width:100%;height:auto"/></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Univariate: GD KDE</h5></div><div class="card-body text-center"><img id="imgKdeGd" alt="GD KDE" style="max-width:100%;height:auto"/></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Univariate: Points Boxplot</h5></div><div class="card-body text-center"><img id="imgBoxPoints" alt="Points Box" style="max-width:100%;height:auto"/></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Bivariate: Scored vs Conceded</h5></div><div class="card-body text-center"><img id="imgScatterSC" alt="Scatter" style="max-width:100%;height:auto"/></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Bivariate: Hexbin Density</h5></div><div class="card-body text-center"><img id="imgHexbinSC" alt="Hexbin" style="max-width:100%;height:auto"/></div></div></div>
            <div class="col-md-4 mb-4"><div class="card"><div class="card-header"><h5>Bivariate: Goals by Venue</h5></div><div class="card-body text-center"><img id="imgBoxVenue" alt="Box by Venue" style="max-width:100%;height:auto"/></div></div></div>
            <div class="col-md-6 mb-4"><div class="card"><div class="card-header"><h5>Multivariate: Correlation Heatmap</h5></div><div class="card-body text-center"><img id="imgCorr" alt="Correlation Heatmap" style="max-width:100%;height:auto"/></div></div></div>
        </div>
        <div class="row" id="h2hSection" style="display: none;"><div class="col-12"><div class="card"><div class="card-header"><h5 class="mb-0">Head-to-Head Results</h5></div><div class="card-body text-center" style="height:400px;"><canvas id="h2hChart"></canvas></div></div></div></div>
        <div class="row" id="leagueTableSection" style="display: none;"><div class="col-12"><div class="card"><div class="card-header"><h5 class="mb-0">League Standings</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-light"><tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead><tbody id="leagueTableBody"></tbody></table></div></div></div></div></div>
    </div>
    <script>
        let resultsChart, formChart, h2hChart, goalsChart, cumulativeChart, goalDiffChart, homeAwayChart, goalsHistChart;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchBtn').addEventListener('click', handleSearch);
            document.getElementById('tableBtn').addEventListener('click', showLeagueTable);
            document.getElementById('seasonInput').addEventListener('change', loadTeamsList);
            loadTeamsList();
        });

        async function apiFetch(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            return data;
        }

        function handleSearch() {
            const team1 = document.getElementById('teamSelect1').value.trim();
            const team2 = document.getElementById('teamSelect2').value.trim();
            const season = document.getElementById('seasonInput').value.trim();
            hideAllSections();

            if (!team1) { showError({ message: "Please select at least Team 1." }); return; }

            document.getElementById('teamChartsSection').style.display = 'flex';
            document.getElementById('team1NameHeader').innerText = `${team1} - Analysis`;
            const baseTeamUrl = `?season=${encodeURIComponent(season)}`;

            apiFetch(`/api/team-stats/${encodeURIComponent(team1)}/${baseTeamUrl}`).then(data => {
                createResultsChart(data);
                createFormChart(data);
            }).catch(showError);

            apiFetch(`/api/goals-over-time/${encodeURIComponent(team1)}/${baseTeamUrl}`).then(createGoalsChart).catch(showError);
            apiFetch(`/api/cumulative-points/${encodeURIComponent(team1)}/${baseTeamUrl}`).then(createCumulativeChart).catch(showError);
            apiFetch(`/api/goal-diff-series/${encodeURIComponent(team1)}/${baseTeamUrl}`).then(createGoalDiffChart).catch(showError);
            apiFetch(`/api/home-away-breakdown/${encodeURIComponent(team1)}/${baseTeamUrl}`).then(createHomeAwayChart).catch(showError);
            apiFetch(`/api/goals-histogram/${encodeURIComponent(team1)}/${baseTeamUrl}`).then(createGoalsHistogram).catch(showError);
            document.getElementById('mplImage').src = `/api/mpl/form-image/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            
            if (team1 && team2) {
                apiFetch(`/api/head-to-head/?team1=${encodeURIComponent(team1)}&team2=${encodeURIComponent(team2)}&season=${encodeURIComponent(season)}`)
                    .then(data => {
                        document.getElementById('h2hSection').style.display = 'block';
                        createH2HChart(data);
                    }).catch(err => showError({ message: `H2H Error: ${err.message}` }));
            }

            // Show Pandas/Matplotlib PNG visuals
            document.getElementById('pandasMplSection').style.display = 'flex';
            document.getElementById('imgHistGoals').src = `/api/mpl/hist-goals/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            document.getElementById('imgKdeGd').src = `/api/mpl/kde-gd/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            document.getElementById('imgBoxPoints').src = `/api/mpl/box-points/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            document.getElementById('imgScatterSC').src = `/api/mpl/scatter-scored-conceded/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            document.getElementById('imgHexbinSC').src = `/api/mpl/hexbin-scored-conceded/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            document.getElementById('imgBoxVenue').src = `/api/mpl/box-goals-by-venue/${encodeURIComponent(team1)}/${baseTeamUrl}`;
            document.getElementById('imgCorr').src = `/api/mpl/corr-heatmap/${encodeURIComponent(team1)}/${baseTeamUrl}`;
        }

        function showLeagueTable() {
            const season = document.getElementById('seasonInput').value.trim();
            hideAllSections();
            document.getElementById('leagueTableSection').style.display = 'block';
            apiFetch(`/api/league-table/?season=${encodeURIComponent(season)}`)
                .then(data => {
                    const tableBody = document.getElementById('leagueTableBody');
                    tableBody.innerHTML = '';
                    data.standings.forEach((team, index) => {
                        tableBody.innerHTML += `<tr><td>${index + 1}</td><td>${team.name}</td><td>${team.played}</td><td>${team.wins}</td><td>${team.draws}</td><td>${team.losses}</td><td>${team.gf}</td><td>${team.ga}</td><td>${team.gd}</td><td><strong>${team.points}</strong></td></tr>`;
                    });
                }).catch(showError);
        }
        
        function createResultsChart(data) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            if (resultsChart) resultsChart.destroy();
            resultsChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Wins', 'Draws', 'Losses'], datasets: [{ data: [data.results.wins, data.results.draws, data.results.losses], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }

        function createFormChart(data) {
            const ctx = document.getElementById('formChart').getContext('2d');
            if (formChart) formChart.destroy();
            formChart = new Chart(ctx, { type: 'line', data: { labels: data.form.dates, datasets: [{ label: '5-Game Rolling Avg Points', data: data.form.rolling_average, borderColor: '#0d6efd', tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function createGoalsChart(data) {
            const ctx = document.getElementById('goalsChart').getContext('2d');
            if (goalsChart) goalsChart.destroy();
            goalsChart = new Chart(ctx, { type: 'line', data: { labels: data.dates.map(d => new Date(d).toLocaleDateString()), datasets: [ { label: 'Scored', data: data.scored, borderColor: 'green', tension: 0.1, fill: false }, { label: 'Conceded', data: data.conceded, borderColor: 'red', tension: 0.1, fill: false } ] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function createH2HChart(data) {
            const ctx = document.getElementById('h2hChart').getContext('2d');
            if (h2hChart) h2hChart.destroy();
            h2hChart = new Chart(ctx, { type: 'pie', data: { labels: [`${data.team1_name} Wins`, `${data.team2_name} Wins`, 'Draws'], datasets: [{ data: [data.results.team1_wins, data.results.team2_wins, data.results.draws], backgroundColor: ['#198754', '#dc3545', '#6c757d'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Head-to-Head: ${data.team1_name} vs ${data.team2_name}` } } } });
        }

        function createCumulativeChart(data) {
            const ctx = document.getElementById('cumulativeChart').getContext('2d');
            if (cumulativeChart) cumulativeChart.destroy();
            cumulativeChart = new Chart(ctx, { type: 'line', data: { labels: data.dates, datasets: [{ label: 'Cumulative Points', data: data.cumulative_points, borderColor: '#198754', tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function createGoalDiffChart(data) {
            const ctx = document.getElementById('goalDiffChart').getContext('2d');
            if (goalDiffChart) goalDiffChart.destroy();
            goalDiffChart = new Chart(ctx, { type: 'bar', data: { labels: data.dates, datasets: [{ label: 'Goal Difference', data: data.goal_diff, backgroundColor: data.goal_diff.map(v => v >= 0 ? 'rgba(25, 135, 84, 0.6)' : 'rgba(220, 53, 69, 0.6)') }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        function createHomeAwayChart(data) {
            const ctx = document.getElementById('homeAwayChart').getContext('2d');
            if (homeAwayChart) homeAwayChart.destroy();
            homeAwayChart = new Chart(ctx, { type: 'bar', data: { labels: ['Wins','Draws','Losses','GF','GA'], datasets: [ { label: 'Home', data: [data.home.wins, data.home.draws, data.home.losses, data.home.gf, data.home.ga], backgroundColor: 'rgba(13, 110, 253, 0.6)' }, { label: 'Away', data: [data.away.wins, data.away.draws, data.away.losses, data.away.gf, data.away.ga], backgroundColor: 'rgba(108, 117, 125, 0.6)' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        function createGoalsHistogram(data) {
            const ctx = document.getElementById('goalsHistChart').getContext('2d');
            if (goalsHistChart) goalsHistChart.destroy();
            goalsHistChart = new Chart(ctx, { type: 'bar', data: { labels: data.bins.map(String), datasets: [{ label: 'Matches per goals scored', data: data.counts, backgroundColor: 'rgba(255, 193, 7, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        function loadTeamsList() {
            const season = document.getElementById('seasonInput').value.trim();
            const sel1 = document.getElementById('teamSelect1');
            const sel2 = document.getElementById('teamSelect2');
            sel1.innerHTML = '<option value="" selected disabled>Select Team 1</option>';
            sel2.innerHTML = '<option value="" selected disabled>Select Team 2</option>';
            
            apiFetch(`/api/teams/?season=${encodeURIComponent(season)}`)
                .then(data => {
                    (data.teams || []).forEach(teamName => {
                        const o1 = document.createElement('option');
                        o1.value = teamName; o1.textContent = teamName; sel1.appendChild(o1);
                        const o2 = document.createElement('option');
                        o2.value = teamName; o2.textContent = teamName; sel2.appendChild(o2);
                    });
                })
                .catch(err => showError({message: `Could not load team list: ${err.message}`}));
        }

        function hideAllSections() {
            document.getElementById('teamChartsSection').style.display = 'none';
            document.getElementById('h2hSection').style.display = 'none';
            document.getElementById('leagueTableSection').style.display = 'none';
            showError(null);
        }

        function showError(error) {
            const errorDiv = document.getElementById('error-message');
            if (error && error.message) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Error: ${error.message}`;
            } else {
                errorDiv.style.display = 'none';
            }
        }
    </script>
</body>
</html>